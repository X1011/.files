#! /usr/bin/env bash

apt-mark showmanual > ~/drive/bak/linux/debian/package-list.txt

pushd ~/.config/rclone >/dev/null

rclone-opt() {
	rclone --verbose --copy-links "$@"
}

(
	rclone-opt sync {,drive-c:bak/linux/debian}/etc --delete-excluded \
		--include-from=etc.include "$@"
	rclone-opt sync {,drive-c:bak/linux/debian/}~ --delete-excluded \
		--filter-from=./~.filter \
		--filter-from=global.filter "$@"
	rclone-opt copy ~/drive drive-c: --filter-from=global.filter --cache-writes "$@"

#  â†“ redirect stderr, too, because that's where rclone outputs the verbose logs
) |& tee bak.log \
| egrep --invert-match \
  -e ': Saving new token in config file' \
  -e ': Modify window is 1ms' \
  -e "Can't transfer non file/directory" \
  -e ': put: cache expired' \
  -e ': received cache expiry notification'
#  -e ': Updated modification time in destination' \

popd >/dev/null
