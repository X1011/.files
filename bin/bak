#! /usr/bin/env bash
set -o errexit

#pacman --query --quiet --explicit > ~/bak/pkg-list.txt

pushd ~/.config/rclone >/dev/null

rclone-bak() {
	rclone --config=rclone.conf --verbose --drive-use-trash --delete-excluded --filter-from=global.filter sync "$@" 2>&1 \
	| egrep --invert-match \
	-e 'Unchanged skipping' \
	-e 'Size and modification time the same' \
	-e 'Sending chunk' \
	-e 'googleapi: Error 403: User rate limit exceeded, userRateLimitExceeded' \
	-e ': Reducing sleep to' \
	-e 'pacer: Rate limited, increasing sleep to ' \
	-e ': (Sizes|Md5sums|Modification times) differ'\
	-e ': (Finished r|R)eading '\
	-e 'pacer: low level retry 1/10'\
	-e '/\.config/xfce4/.+?: Size and MD5 of src and dst objects identical'
	#-e '' \
	#-e "Can't transfer non file/directory" \
}

rclone-bak {,drive:bak/linux/arch}/etc --exclude-from=etc.exclude --max-size=640k "$@"
rclone-bak {,drive:bak/linux/arch/}~   --exclude-from=./~.exclude --filter-from=./~.filter "$@"

popd >/dev/null
